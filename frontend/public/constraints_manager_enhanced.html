<!doctype html>
<html lang="fr" data-locale="fr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion des contraintes & G√©n√©ration - Version Am√©lior√©e</title>
  <style>
    body {
      font-family: system-ui, sans-serif; 
      margin:0; 
      background:#f5f6fa; 
      color:#1f2937;
      direction: ltr;
    }
    
    /* Header avec notifications */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-indicator.connected {
      background: #4ade80;
    }
    
    .status-indicator.disconnected {
      background: #f87171;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Layout principal */
    .main-container {
      display: flex;
      gap: 20px;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* Panel de contraintes */
    .constraints-panel {
      flex: 0 0 400px;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }
    
    .constraint-form {
      background: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .constraint-form h3 {
      margin-top: 0;
      color: #667eea;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #4b5563;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .constraint-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
      position: relative;
    }
    
    .constraint-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }
    
    .constraint-item.new-constraint {
      animation: slideIn 0.3s ease-out;
      background: linear-gradient(90deg, #f0f9ff, white);
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .constraint-info {
      flex: 1;
    }
    
    .constraint-type {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .constraint-entity {
      font-weight: 600;
      color: #1f2937;
      margin: 4px 0;
    }
    
    .constraint-details {
      font-size: 13px;
      color: #6b7280;
    }
    
    .constraint-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-icon {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .btn-icon:hover {
      background: #e5e7eb;
    }
    
    .btn-icon.active {
      background: #4ade80;
      color: white;
    }
    
    .btn-icon.delete:hover {
      background: #f87171;
      color: white;
    }
    
    /* Panel de visualisation */
    .schedule-panel {
      flex: 1;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: relative;
    }
    
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f3f4f6;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Progress bar am√©lior√©e */
    .progress-container {
      display: none;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .progress-container.active {
      display: block;
    }
    
    .progress-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Notifications flottantes */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .notification {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideInRight 0.3s ease-out;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .notification.success {
      border-left: 4px solid #4ade80;
    }
    
    .notification.error {
      border-left: 4px solid #f87171;
    }
    
    .notification.info {
      border-left: 4px solid #60a5fa;
    }
    
    .notification-icon {
      font-size: 20px;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 2px;
    }
    
    .notification-message {
      font-size: 14px;
      color: #6b7280;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 20px;
    }
    
    /* Table am√©lior√©e */
    .schedule-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
    }
    
    .schedule-table th,
    .schedule-table td {
      padding: 12px;
      text-align: center;
      border: 1px solid #e5e7eb;
    }
    
    .schedule-table thead th {
      background: #f9fafb;
      font-weight: 600;
      color: #4b5563;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .schedule-table tbody td {
      background: white;
      transition: background 0.2s;
    }
    
    .schedule-table tbody tr:hover td {
      background: #f9fafb;
    }
    
    .cell-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    .subject-badge {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .teacher-name {
      font-size: 11px;
      color: #6b7280;
    }
    
    /* Chat AI int√©gr√© */
    .ai-chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .ai-chat-button {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      transition: transform 0.3s;
      font-size: 28px;
    }
    
    .ai-chat-button:hover {
      transform: scale(1.1);
    }
    
    /* Loading spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f4f6;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header avec statut de connexion -->
  <div class="header">
    <h1>üéØ Syst√®me de Gestion des Contraintes - Temps R√©el</h1>
    <div class="connection-status">
      <div class="status-indicator disconnected" id="connectionStatus"></div>
      <span id="connectionText">Mode hors ligne (polling actif)</span>
    </div>
  </div>

  <!-- Container principal -->
  <div class="main-container">
    <!-- Panel de contraintes -->
    <div class="constraints-panel">
      <!-- Formulaire d'ajout rapide -->
      <div class="constraint-form">
        <h3>‚ûï Ajouter une contrainte</h3>
        <div class="form-group">
          <label>Description en langage naturel</label>
          <textarea 
            id="constraintText" 
            placeholder="Ex: Le professeur Cohen ne peut pas enseigner le vendredi..."
            rows="3"
          ></textarea>
        </div>
        <div class="form-group">
          <label>Ou utiliser le formulaire structur√©:</label>
          <select id="constraintType">
            <option value="">-- Choisir un type --</option>
            <option value="teacher_availability">Disponibilit√© professeur</option>
            <option value="class_preference">Pr√©f√©rence classe</option>
            <option value="room_assignment">Affectation salle</option>
            <option value="time_preference">Pr√©f√©rence horaire</option>
            <option value="consecutive_hours">Heures cons√©cutives</option>
          </select>
        </div>
        <div class="form-group">
          <label>Entit√© concern√©e</label>
          <input type="text" id="entityName" placeholder="Ex: Prof. Cohen, Classe 7A...">
        </div>
        <div class="form-group">
          <label>Priorit√©</label>
          <select id="priority">
            <option value="0">üî¥ Critique (obligatoire)</option>
            <option value="1">üü† Haute</option>
            <option value="2" selected>üü° Moyenne</option>
            <option value="3">üü¢ Basse</option>
          </select>
        </div>
        <button class="btn-primary" onclick="addConstraint()">
          <span>‚ûï</span>
          <span>Ajouter la contrainte</span>
        </button>
      </div>

      <!-- Liste des contraintes actives -->
      <h3>üìã Contraintes actives</h3>
      <div id="constraintsList">
        <!-- Les contraintes seront affich√©es ici dynamiquement -->
      </div>
    </div>

    <!-- Panel de visualisation -->
    <div class="schedule-panel">
      <!-- Toolbar -->
      <div class="toolbar">
        <div>
          <select id="viewSelector">
            <option value="class">üìö Vue par classe</option>
            <option value="teacher">üë• Vue par professeur</option>
          </select>
          <select id="entitySelector">
            <option value="">S√©lectionner...</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn-primary" onclick="generateSchedule()">
            <span>üöÄ</span>
            <span>G√©n√©rer l'emploi du temps</span>
          </button>
          <button class="btn-primary" onclick="refreshSchedule()" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
            <span>üîÑ</span>
            <span>Rafra√Æchir</span>
          </button>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="progress-container" id="progressContainer">
        <div class="progress-label" id="progressLabel">G√©n√©ration en cours...</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Table de l'emploi du temps -->
      <div id="scheduleContainer">
        <div style="text-align: center; padding: 40px; color: #9ca3af;">
          <div class="spinner"></div>
          <p>Chargement de l'emploi du temps...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Container de notifications -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- Chat AI Widget -->
  <div class="ai-chat-widget">
    <div class="ai-chat-button" onclick="openAIAgent()">ü§ñ</div>
  </div>

  <script>
    // Configuration
    const API_BASE = 'http://localhost:8000';
    const AI_AGENT_URL = 'http://localhost:5001';
    
    // √âtat global
    let currentConstraints = [];
    let currentSchedule = null;
    let ws = null;
    let reconnectTimer = null;
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      // D√©marrer sans WebSocket d'abord
      loadConstraints();
      loadSchedule();
      setupPolling(); // Utiliser le polling par d√©faut
      
      // Essayer d'initialiser Socket.IO apr√®s
      setTimeout(() => {
        initWebSocket();
      }, 1000);
    });
    
    // Socket.IO pour temps r√©el (au lieu de WebSocket natif)
    function initWebSocket() {
      try {
        // Utiliser Socket.IO qui est d√©j√† configur√© sur le port 5001
        const script = document.createElement('script');
        script.src = 'https://cdn.socket.io/4.5.0/socket.io.min.js';
        document.head.appendChild(script);
        
        script.onload = () => {
          const socket = io(AI_AGENT_URL, {
            transports: ['websocket', 'polling'],
            reconnection: true
          });
          
          socket.on('connect', () => {
            console.log('Socket.IO connect√©');
            updateConnectionStatus(true);
            showNotification('success', 'Connexion √©tablie', 'Syst√®me pr√™t pour les mises √† jour temps r√©el');
            ws = socket; // Utiliser socket au lieu de WebSocket natif
          });
          
          socket.on('constraint_added', (data) => {
            handleWebSocketMessage({ type: 'constraint_added', constraint: data });
          });
          
          socket.on('schedule_updated', (data) => {
            handleWebSocketMessage({ type: 'schedule_updated', ...data });
          });
          
          socket.on('disconnect', () => {
            console.log('Socket.IO d√©connect√©');
            updateConnectionStatus(false);
          });
        };
      } catch (error) {
        console.error('Erreur Socket.IO:', error);
        // Fallback sur polling
        setupPolling();
      }
    }
    
    function handleWebSocketMessage(data) {
      switch(data.type) {
        case 'constraint_added':
          addConstraintToList(data.constraint, true);
          showNotification('success', 'Nouvelle contrainte', `${data.constraint.entity}: ${data.constraint.type}`);
          break;
        
        case 'constraint_removed':
          removeConstraintFromList(data.constraintId);
          break;
        
        case 'schedule_updated':
          showNotification('info', 'Emploi du temps mis √† jour', 'Rafra√Æchissement automatique...');
          setTimeout(() => refreshSchedule(), 1000);
          break;
        
        case 'generation_progress':
          updateProgress(data.progress, data.message);
          break;
        
        case 'generation_complete':
          showNotification('success', 'G√©n√©ration termin√©e', `Score de qualit√©: ${data.quality_score}/100`);
          refreshSchedule();
          hideProgress();
          break;
      }
    }
    
    // Gestion des contraintes
    async function loadConstraints() {
      try {
        const response = await fetch(`${API_BASE}/api/constraints`);
        const data = await response.json();
        currentConstraints = data.constraints || [];
        displayConstraints();
      } catch (error) {
        console.error('Erreur chargement contraintes:', error);
        showNotification('error', 'Erreur', 'Impossible de charger les contraintes');
      }
    }
    
    async function addConstraint() {
      const text = document.getElementById('constraintText').value;
      const type = document.getElementById('constraintType').value;
      const entity = document.getElementById('entityName').value;
      const priority = document.getElementById('priority').value;
      
      if (!text && !type) {
        showNotification('error', 'Erreur', 'Veuillez remplir au moins un champ');
        return;
      }
      
      try {
        let constraintData = {};
        
        // Si texte naturel, envoyer √† l'agent AI pour parsing via le proxy du backend
        if (text) {
          // Utiliser le proxy du backend pour √©viter CORS
          const aiResponse = await fetch(`${API_BASE}/api/parse_constraint`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, language: detectLanguage(text) })
          });
          
          if (aiResponse.ok) {
            const parsed = await aiResponse.json();
            constraintData = parsed.constraint;
          } else {
            // Fallback: cr√©er contrainte basique
            constraintData = {
              type: type || 'custom',
              entity: entity || 'Global',
              data: { original_text: text },
              priority: parseInt(priority)
            };
          }
        } else {
          // Formulaire structur√©
          constraintData = {
            type: type,
            entity: entity || 'Global',
            data: { 
              type: type,
              entity: entity
            },
            priority: parseInt(priority)
          };
        }
        
        // Envoyer au backend
        const response = await fetch(`${API_BASE}/api/constraints`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(constraintData)
        });
        
        if (response.ok) {
          const newConstraint = await response.json();
          
          // Ajouter √† la liste avec animation
          addConstraintToList(newConstraint, true);
          
          // Vider le formulaire
          document.getElementById('constraintText').value = '';
          document.getElementById('constraintType').value = '';
          document.getElementById('entityName').value = '';
          
          showNotification('success', 'Contrainte ajout√©e', 'La contrainte a √©t√© enregistr√©e');
          
          // Envoyer via Socket.IO pour notifier les autres clients
          if (ws && ws.connected) {
            ws.emit('constraint_added', newConstraint);
          }
        } else {
          throw new Error('Erreur serveur');
        }
      } catch (error) {
        console.error('Erreur ajout contrainte:', error);
        showNotification('error', 'Erreur', 'Impossible d\'ajouter la contrainte');
      }
    }
    
    function displayConstraints() {
      const container = document.getElementById('constraintsList');
      container.innerHTML = '';
      
      currentConstraints.forEach(constraint => {
        addConstraintToList(constraint, false);
      });
    }
    
    function addConstraintToList(constraint, animate = false) {
      const container = document.getElementById('constraintsList');
      
      // V√©rifier si la contrainte existe d√©j√†
      const existing = document.getElementById(`constraint-${constraint.constraint_id}`);
      if (existing) {
        existing.remove();
      }
      
      const item = document.createElement('div');
      item.className = 'constraint-item' + (animate ? ' new-constraint' : '');
      item.id = `constraint-${constraint.constraint_id}`;
      
      const priorityColors = ['üî¥', 'üü†', 'üü°', 'üü¢'];
      const priorityIcon = priorityColors[constraint.priority] || '‚ö™';
      
      item.innerHTML = `
        <div class="constraint-info">
          <div class="constraint-type">${priorityIcon} ${constraint.type || constraint.constraint_type}</div>
          <div class="constraint-entity">${constraint.entity || constraint.entity_name}</div>
          <div class="constraint-details">${formatConstraintDetails(constraint.data || constraint.constraint_data)}</div>
        </div>
        <div class="constraint-actions">
          <button class="btn-icon ${constraint.is_active ? 'active' : ''}" 
                  onclick="toggleConstraint(${constraint.constraint_id}, ${!constraint.is_active})"
                  title="Activer/D√©sactiver">
            ${constraint.is_active ? '‚úì' : '‚óã'}
          </button>
          <button class="btn-icon delete" 
                  onclick="deleteConstraint(${constraint.constraint_id})"
                  title="Supprimer">
            üóëÔ∏è
          </button>
        </div>
      `;
      
      container.insertBefore(item, container.firstChild);
      
      // Retirer l'animation apr√®s
      if (animate) {
        setTimeout(() => {
          item.classList.remove('new-constraint');
        }, 1000);
      }
    }
    
    function removeConstraintFromList(constraintId) {
      const element = document.getElementById(`constraint-${constraintId}`);
      if (element) {
        element.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => element.remove(), 300);
      }
    }
    
    async function toggleConstraint(id, active) {
      try {
        const response = await fetch(`${API_BASE}/api/constraints/${id}/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: active })
        });
        
        if (response.ok) {
          // Mettre √† jour l'UI
          const btn = document.querySelector(`#constraint-${id} .btn-icon`);
          if (btn) {
            btn.classList.toggle('active', active);
            btn.innerHTML = active ? '‚úì' : '‚óã';
          }
          
          showNotification('info', 'Contrainte modifi√©e', active ? 'Contrainte activ√©e' : 'Contrainte d√©sactiv√©e');
        }
      } catch (error) {
        console.error('Erreur toggle:', error);
      }
    }
    
    async function deleteConstraint(id) {
      if (!confirm('Supprimer cette contrainte ?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/constraints/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          removeConstraintFromList(id);
          showNotification('success', 'Contrainte supprim√©e', 'La contrainte a √©t√© retir√©e');
          
          // Notifier via Socket.IO
          if (ws && ws.connected) {
            ws.emit('constraint_removed', { constraintId: id });
          }
        }
      } catch (error) {
        console.error('Erreur suppression:', error);
      }
    }
    
    // G√©n√©ration et affichage de l'emploi du temps
    async function generateSchedule() {
      showProgress();
      updateProgress(0, 'Initialisation...');
      
      try {
        // Collecter les contraintes actives
        const activeConstraints = currentConstraints.filter(c => c.is_active);
        
        updateProgress(20, 'Envoi des contraintes...');
        
        const response = await fetch(`${API_BASE}/generate_schedule`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            advanced: true,
            time_limit: 600,
            constraints: activeConstraints,
            optimize_quality: true
          })
        });
        
        updateProgress(40, 'Optimisation en cours...');
        
        // Simuler la progression
        let progress = 40;
        const progressInterval = setInterval(() => {
          if (progress < 90) {
            progress += Math.random() * 10;
            updateProgress(Math.min(progress, 90), 'Calcul des meilleures solutions...');
          }
        }, 1000);
        
        if (response.ok) {
          const result = await response.json();
          clearInterval(progressInterval);
          
          updateProgress(100, 'G√©n√©ration termin√©e!');
          
          showNotification('success', 'Emploi du temps g√©n√©r√©', 
            `Score de qualit√©: ${result.quality_score || 'N/A'}/100`);
          
          // Rafra√Æchir l'affichage apr√®s 1 seconde
          setTimeout(() => {
            refreshSchedule();
            hideProgress();
          }, 1000);
          
        } else {
          clearInterval(progressInterval);
          throw new Error('Erreur g√©n√©ration');
        }
      } catch (error) {
        console.error('Erreur g√©n√©ration:', error);
        showNotification('error', 'Erreur', 'Impossible de g√©n√©rer l\'emploi du temps');
        hideProgress();
      }
    }
    
    async function loadSchedule() {
      try {
        const response = await fetch(`${API_BASE}/api/schedule_entries?version=latest`);
        if (response.ok) {
          const data = await response.json();
          currentSchedule = data;
          displaySchedule();
          
          // Mettre √† jour les s√©lecteurs
          updateEntitySelectors();
        }
      } catch (error) {
        console.error('Erreur chargement emploi du temps:', error);
      }
    }
    
    async function refreshSchedule() {
      await loadSchedule();
      showNotification('success', 'Actualis√©', 'L\'emploi du temps a √©t√© rafra√Æchi');
    }
    
    function displaySchedule() {
      const container = document.getElementById('scheduleContainer');
      
      if (!currentSchedule || !currentSchedule.entries || currentSchedule.entries.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #9ca3af;">
            <p>Aucun emploi du temps disponible</p>
            <p style="margin-top: 10px;">Cliquez sur "G√©n√©rer l'emploi du temps" pour commencer</p>
          </div>
        `;
        return;
      }
      
      // Cr√©er la table
      const viewType = document.getElementById('viewSelector').value;
      const selectedEntity = document.getElementById('entitySelector').value;
      
      if (!selectedEntity) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #9ca3af;">
            <p>S√©lectionnez une ${viewType === 'class' ? 'classe' : 'professeur'} pour voir l'emploi du temps</p>
          </div>
        `;
        return;
      }
      
      // Filtrer les entr√©es
      const filtered = currentSchedule.entries.filter(entry => {
        if (viewType === 'class') {
          return entry.class_name === selectedEntity;
        } else {
          return entry.teacher_names && entry.teacher_names.includes(selectedEntity);
        }
      });
      
      // Construire la table HTML
      const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
      const periods = 10;
      
      let html = '<table class="schedule-table"><thead><tr><th>P√©riode</th>';
      days.forEach(day => {
        html += `<th>${day}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      for (let p = 0; p < periods; p++) {
        html += `<tr><td><strong>P${p+1}</strong><br><small>8:00-8:45</small></td>`;
        
        for (let d = 0; d < days.length; d++) {
          const entry = filtered.find(e => e.day === d && e.slot_index === p);
          
          if (entry) {
            html += `<td>
              <div class="cell-content">
                <div class="subject-badge">${entry.subject || '‚Äî'}</div>
                <div class="teacher-name">${viewType === 'class' ? 
                  (entry.teacher_names ? entry.teacher_names.join(', ') : '') : 
                  entry.class_name}</div>
              </div>
            </td>`;
          } else {
            html += '<td>‚Äî</td>';
          }
        }
        html += '</tr>';
      }
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function updateEntitySelectors() {
      if (!currentSchedule || !currentSchedule.entries) return;
      
      const viewType = document.getElementById('viewSelector').value;
      const selector = document.getElementById('entitySelector');
      
      // Extraire les entit√©s uniques
      const entities = new Set();
      currentSchedule.entries.forEach(entry => {
        if (viewType === 'class' && entry.class_name) {
          entities.add(entry.class_name);
        } else if (viewType === 'teacher' && entry.teacher_names) {
          entry.teacher_names.forEach(t => entities.add(t));
        }
      });
      
      // Mettre √† jour le s√©lecteur
      const current = selector.value;
      selector.innerHTML = '<option value="">S√©lectionner...</option>';
      
      Array.from(entities).sort().forEach(entity => {
        const option = document.createElement('option');
        option.value = entity;
        option.textContent = entity;
        selector.appendChild(option);
      });
      
      // Restaurer la s√©lection si possible
      if (current && Array.from(entities).includes(current)) {
        selector.value = current;
      }
    }
    
    // Utilitaires
    function detectLanguage(text) {
      const hebrewChars = (text.match(/[\u0590-\u05FF]/g) || []).length;
      return hebrewChars > text.length * 0.3 ? 'he' : 'fr';
    }
    
    function formatConstraintDetails(data) {
      if (typeof data === 'string') {
        try {
          data = JSON.parse(data);
        } catch {
          return data;
        }
      }
      
      if (data.original_text) {
        return data.original_text.substring(0, 50) + (data.original_text.length > 50 ? '...' : '');
      }
      
      if (data.description) {
        return data.description;
      }
      
      // Formater les d√©tails selon le type
      const details = [];
      if (data.days) details.push(`Jours: ${data.days.join(', ')}`);
      if (data.periods) details.push(`P√©riodes: ${data.periods.join(', ')}`);
      if (data.room) details.push(`Salle: ${data.room}`);
      
      return details.join(' | ') || 'D√©tails non disponibles';
    }
    
    function updateConnectionStatus(connected) {
      const indicator = document.getElementById('connectionStatus');
      const text = document.getElementById('connectionText');
      
      if (connected) {
        indicator.className = 'status-indicator connected';
        text.textContent = 'Connect√©';
      } else {
        indicator.className = 'status-indicator disconnected';
        text.textContent = 'D√©connect√©';
      }
    }
    
    function showProgress() {
      const container = document.getElementById('progressContainer');
      container.classList.add('active');
    }
    
    function hideProgress() {
      const container = document.getElementById('progressContainer');
      container.classList.remove('active');
      document.getElementById('progressFill').style.width = '0%';
    }
    
    function updateProgress(percent, message) {
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressLabel').textContent = message || 'Traitement...';
    }
    
    function showNotification(type, title, message) {
      const container = document.getElementById('notificationContainer');
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };
      
      notification.innerHTML = `
        <div class="notification-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
      `;
      
      container.appendChild(notification);
      
      // Auto-remove apr√®s 5 secondes
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }
    
    function openAIAgent() {
      // Ouvrir l'agent AI dans une nouvelle fen√™tre ou modal
      window.open(`${AI_AGENT_URL}/chat`, 'AI Agent', 'width=400,height=600');
    }
    
    // Auto-refresh toutes les 30 secondes si connect√©
    function setupAutoRefresh() {
      setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          loadConstraints();
        }
      }, 30000);
    }
    
    // Fallback polling si WebSocket √©choue
    function setupPolling() {
      console.log('Mode polling activ√© - rafra√Æchissement automatique toutes les 5 secondes');
      setInterval(() => {
        loadConstraints();
        // Ne pas recharger l'emploi du temps automatiquement pour √©viter les interruptions
        // loadSchedule();
      }, 5000);
    }
    
    // Event listeners
    document.getElementById('viewSelector').addEventListener('change', () => {
      updateEntitySelectors();
      displaySchedule();
    });
    
    document.getElementById('entitySelector').addEventListener('change', () => {
      displaySchedule();
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'g':
            e.preventDefault();
            generateSchedule();
            break;
          case 'r':
            e.preventDefault();
            refreshSchedule();
            break;
          case 'a':
            e.preventDefault();
            document.getElementById('constraintText').focus();
            break;
        }
      }
    });
  </script>
</body>
</html>