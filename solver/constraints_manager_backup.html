<!doctype html>
<html lang="fr" data-locale="fr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion des contraintes & GÃ©nÃ©ration</title>
    <style>
        body {
      font-family: system-ui, sans-serif; 
      margin:0; 
      background:#ffffff; 
      color:#1f2937;
      direction: ltr;
    }
    [dir="rtl"] {
      direction: rtl;
    }
    [dir="rtl"] .toolbar {
      flex-direction: row-reverse;
    }
    [dir="rtl"] .tabs {
      flex-direction: row-reverse;
    }
    .wrap { 
      display:flex; 
      gap:16px; 
      padding:16px; 
      min-height: 100vh;
    }
    .panel { 
      background:#ffffff; 
      border:1px solid #e5e7eb; 
      border-radius:12px; 
      padding:16px; 
    }
    .left { 
      flex: 0 0 35%; 
      min-width:320px; 
    }
    .right{ 
      flex: 1; 
      display:flex; 
      flex-direction:column; 
      gap:12px; 
    }
    .constraint-section {
            margin-bottom: 20px;
        }
    .constraint-section h3 {
      color: #58a6ff;
      margin-bottom: 12px;
      font-size: 1.1em;
    }
    .constraint-item {
            display: flex;
            align-items: center;
      gap: 8px;
      padding: 8px;
      background: #f8fafc;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .constraint-item label {
      cursor: pointer;
      flex: 1;
    }
    .constraint-item input[type="checkbox"] {
      margin-right: 8px;
    }
    .weight-slider {
      width: 60px;
      margin-left: auto;
    }
    .toolbar { 
      display:flex; 
      gap:8px; 
      align-items:center; 
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    button.primary { 
      background:#3b82f6; 
      color:white; 
      border:0; 
      padding:12px 16px; 
      border-radius:10px; 
      cursor:pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    button.primary:hover {
      background:#2563eb;
    }
    button[disabled]{ 
      opacity:.6; 
      cursor:not-allowed; 
    }
    .status-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
      margin-top: 10px;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      display: none;
    }
    .progress-fill {
      height: 100%;
      background: #3b82f6;
      width: 0%;
      transition: width 0.3s ease;
    }
    .tabs { 
      display:flex; 
      gap:8px; 
      margin-top:8px; 
    }
    .tab { 
      padding:8px 12px; 
      border-radius:10px; 
      cursor:pointer; 
      background:#f3f4f6;
            transition: all 0.2s;
        }
    .tab.active{ 
      background:#ffffff; 
      border:1px solid #d1d5db; 
    }
    .tab:hover {
      background:#e5e7eb;
    }
    .controls-row {
            display: flex;
      gap: 8px;
      align-items: center;
      margin-left: auto;
      flex-wrap: wrap;
    }
    .grid { 
      overflow:auto; 
      border:1px solid #e5e7eb; 
      border-radius:12px;
      max-height: 70vh;
    }
    table.timetable { 
      border-collapse:separate; 
      border-spacing:0; 
      width:100%; 
      font-size: 13px;
    }
    table.timetable th, table.timetable td { 
      padding:8px; 
      border-bottom:1px solid #e5e7eb; 
      text-align: center;
    }
    table.timetable thead th { 
      position:sticky; 
      top:0; 
      background:#f3f4f6; 
      z-index:1;
      font-weight: 600;
    }
    .cell { 
      border-left:1px solid #e5e7eb; 
      min-width:140px; 
      min-height:56px;
      vertical-align: top;
    }
    .cell-content {
            display: flex;
            flex-direction: column;
      gap: 4px;
            align-items: center;
    }
    .badge { 
      display:inline-block; 
      padding:2px 6px; 
      border-radius:8px; 
      background:#e8f0fe;
      font-size: 11px;
      font-weight: 500;
    }
    .teacher-info {
      font-size: 10px;
      color: #6b7280;
    }
    .toast { 
      position:fixed; 
      right:16px; 
      bottom:16px; 
      background:#ffffff; 
      border:1px solid #e5e7eb; 
      color:#1f2937; 
      padding:12px 16px; 
      border-radius:10px; 
      display:none;
      z-index: 1000;
      max-width: 300px;
    }
    .toast.error {
      border-color: #fca5a5;
      background: #fff1f2;
    }
    .toast.success {
      border-color: #86efac;
      background: #f0fdf4;
    }
    .meta-info {
      background: #f9fafb;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
      color: #6b7280;
    }
    .meta-info strong {
      color: #111827;
    }
    select {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 13px;
    }
    button {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 6px 12px;
            cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    button:hover {
      background: #f3f4f6;
    }
    .empty-state {
            text-align: center;
      padding: 40px;
      color: #8b949e;
    }
    h2 {
      color: #58a6ff;
      margin-bottom: 16px;
        }
    </style>
</head>
<body>
<div class="wrap">
  <!-- Panneau gauche : contraintes -->
  <section class="panel left">
    <h2>âš™ï¸ Contraintes & GÃ©nÃ©ration</h2>
    
    <div class="constraint-section">
      <h3>Contraintes dures</h3>
      <div class="constraint-item">
        <label><input type="checkbox" id="limit_consecutive" checked> Limiter heures consÃ©cutives (prof/classe)</label>
            </div>
      <div class="constraint-item">
        <label><input type="checkbox" id="avoid_late_hard" checked> Ã‰viter matiÃ¨res "dures" en fin de journÃ©e</label>
            </div>
      <div class="constraint-item">
        <label><input type="checkbox" id="friday_short" checked> Vendredi Ã©courtÃ©</label>
            </div>
        </div>

    <div class="constraint-section">
      <h3>Contraintes souples</h3>
      <div class="constraint-item">
        <label><input type="checkbox" id="minimize_gaps" checked> Minimiser "trous" profs</label>
        </div>
      <div class="constraint-item">
        <label><input type="checkbox" id="morning_priority" checked> PrioritÃ© matiÃ¨res importantes le matin</label>
                    </div>
      <div class="constraint-item">
        <label><input type="checkbox" id="balanced_days" checked> Ã‰quilibrer la charge par jour</label>
                        </div>
                        </div>
                        
    <div class="toolbar">
      <button id="btnRun" class="primary">ğŸš€ GÃ©nÃ©ration avancÃ©e</button>
                        </div>
                        
    <div class="status-container">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span>Statut:</span>
        <span id="status" class="badge">PrÃªt</span>
                </div>
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

    <div class="meta-info" id="meta" style="display: none;">
      <div id="metaContent"></div>
                </div>
  </section>

  <!-- Panneau droit : rÃ©sultats -->
  <section class="panel right">
    <div class="tabs">
      <div class="tab active" data-tab="classes">ğŸ“š Classes</div>
      <div class="tab" data-tab="teachers">ğŸ‘¥ Professeurs</div>
      <div class="controls-row">
        <select id="selector">
          <option value="">SÃ©lectionner...</option>
        </select>
        <select id="subjectFilter">
          <option value="">Toutes matiÃ¨res</option>
        </select>
        <button id="btnExport">ğŸ“Š Exporter CSV</button>
        <button id="btnPrint">ğŸ–¨ï¸ Imprimer</button>
        <button id="btnReset">ğŸ”„ Reset filtres</button>
                </div>
            </div>
    <div class="grid">
      <div id="emptyState" class="empty-state">
        <p>ğŸ¯ Cliquez sur "GÃ©nÃ©ration avancÃ©e" pour crÃ©er un emploi du temps</p>
        <p style="margin-top: 8px; font-size: 12px;">ou sÃ©lectionnez une classe/professeur si un planning existe dÃ©jÃ </p>
        </div>
      <table class="timetable" id="table" style="display: none;"></table>
                </div>
  </section>
                    </div>
<div class="toast" id="toast"></div>

    <script>
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const API_GEN  = '/generate_schedule';
const API_ENTR = '/api/schedule_entries?version=latest';

let currentTab = 'classes';
let schedule = null; // { time_slots, entries, meta }
let classesList = [];
let teachersList = [];
let subjectsList = [];
let currentFilter = { subject: '' };

// Noms des jours en franÃ§ais
const DAYS_FR = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

function toast(msg, type='info'){
  const t = $('#toast'); 
  t.textContent = msg; 
  t.style.display='block';
  t.className = `toast ${type}`;
  setTimeout(()=> t.style.display='none', 4000);
}

async function runAdvanced(){
  $('#btnRun').disabled = true; 
  $('#status').textContent = 'Initialisationâ€¦';
  showProgress(true);
  
  try{
    // Collecter les contraintes sÃ©lectionnÃ©es
    const payload = {
      advanced: true,
      time_limit: 600,
      limit_consecutive: $('#limit_consecutive').checked,
      avoid_late_hard: $('#avoid_late_hard').checked,
      minimize_gaps: $('#minimize_gaps').checked,
      friday_short: $('#friday_short').checked
    };
    
    console.log('Payload envoyÃ©:', payload);
    
    $('#status').textContent = 'Lancementâ€¦';
    const response = await fetch(API_GEN, {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(payload)
    });
    
                if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('RÃ©sultat gÃ©nÃ©ration:', result);
    
    if (result.success) {
      $('#status').textContent = 'Optimisationâ€¦';
      await pollUntilDone();
                    } else {
      throw new Error(result.message || 'Ã‰chec de gÃ©nÃ©ration');
    }
  }catch(e){
    console.error('Erreur gÃ©nÃ©ration:', e); 
    toast(`Erreur de lancement: ${e.message}`, 'error');
    $('#status').textContent = 'Erreur';
  }finally{
    $('#btnRun').disabled = false;
    showProgress(false);
  }
}

function showProgress(show) {
  const bar = $('#progressBar');
  if (show) {
    bar.style.display = 'block';
    simulateProgress();
  } else {
    bar.style.display = 'none';
    $('#progressFill').style.width = '0%';
  }
}

function simulateProgress() {
  const fill = $('#progressFill');
  let progress = 0;
  const interval = setInterval(() => {
    progress += Math.random() * 10;
    if (progress > 95) progress = 95;
    fill.style.width = progress + '%';
    
    if (!$('#progressBar').style.display || $('#progressBar').style.display === 'none') {
      clearInterval(interval);
    }
  }, 500);
}

async function pollUntilDone(){
  // Polling des rÃ©sultats (toutes les 2s, max 60s)
  for (let i=0;i<30;i++){
    await new Promise(r=>setTimeout(r, 2000));
    const ok = await loadSchedule();
    if(ok && schedule.meta){
      const status = schedule.meta.solve_status;
      if(status==='OPTIMAL' || status==='FEASIBLE'){
        $('#status').textContent = status === 'OPTIMAL' ? 'Optimal âœ…' : 'Faisable âœ…';
        toast('Planning gÃ©nÃ©rÃ© avec succÃ¨s! ğŸ‰', 'success');
        showMeta();
        renderAll();
                            return;
                        }
      if(status==='INFEASIBLE' || status==='ERROR'){
        $('#status').textContent = status === 'INFEASIBLE' ? 'Infaisable âŒ' : 'Erreur âŒ';
        toast('Aucune solution trouvÃ©e. Essayez de relaxer les contraintes.', 'error');
        showMeta();
                            return;
      }
    }
    $('#status').textContent = `Calcul en coursâ€¦ (${i*2}s)`;
  }
  toast('Timeout sans rÃ©sultat. Le calcul peut encore Ãªtre en cours.', 'error');
  $('#status').textContent = 'Timeout';
}

async function loadSchedule(){
  try{
    console.log('Chargement du planning...');
    const res = await fetch(API_ENTR);
    if(!res.ok) {
      console.error('Erreur API:', res.status, res.statusText);
      return false;
    }
    schedule = await res.json();
    console.log('Planning chargÃ©:', schedule);
    
    // Normalisations
    schedule.entries = schedule.entries.map(e => ({
      ...e,
      teacher_names: Array.isArray(e.teacher_names) ? e.teacher_names :
        String(e.teacher_names||'').split(',').map(s=>s.trim()).filter(Boolean)
    }));
    
    buildSelectors();
    buildSubjectFilter();
    return true;
  }catch(e){ 
    console.error('Erreur loadSchedule:', e); 
    return false; 
  }
}

function buildSelectors(){
  const classes = new Set();
  const teachers = new Set();
  
  for(const e of schedule.entries){
    if (e.class_name) classes.add(e.class_name);
    for(const t of e.teacher_names) if(t) teachers.add(t);
  }
  
  classesList = Array.from(classes).sort();
  teachersList = Array.from(teachers).sort();
  
  const sel = $('#selector');
  sel.innerHTML = '<option value="">SÃ©lectionner...</option>';
  const arr = currentTab==='classes' ? classesList : teachersList;
  for(const v of arr){
    const opt = document.createElement('option'); 
    opt.value=v; 
    opt.textContent=v; 
    sel.appendChild(opt);
  }
  
  // Auto-sÃ©lectionner le premier Ã©lÃ©ment s'il y en a
  if (arr.length > 0 && !sel.value) {
    sel.value = arr[0];
  }
}

function buildSubjectFilter(){
  const subjects = new Set();
  for(const e of schedule.entries){
    if (e.subject) subjects.add(e.subject);
  }
  
  subjectsList = Array.from(subjects).sort();
  
  const filter = $('#subjectFilter');
  const currentValue = filter.value;
  filter.innerHTML = '<option value="">Toutes matiÃ¨res</option>';
  for(const s of subjectsList){
    const opt = document.createElement('option'); 
    opt.value=s; 
    opt.textContent=s; 
    filter.appendChild(opt);
  }
  
  // Restaurer la sÃ©lection prÃ©cÃ©dente si possible
  if (currentValue && subjectsList.includes(currentValue)) {
    filter.value = currentValue;
  }
}

function renderAll(){
  if(!schedule || !schedule.time_slots || schedule.entries.length === 0) { 
    $('#table').style.display = 'none';
    $('#emptyState').style.display = 'block';
                return;
            }
            
  $('#emptyState').style.display = 'none';
  $('#table').style.display = 'table';
  
  const selVal = $('#selector').value;
  if(!selVal) {
    $('#table').innerHTML = '<tbody><tr><td colspan="8" style="text-align:center; padding:20px;">SÃ©lectionnez une classe ou un professeur</td></tr></tbody>';
                return;
            }
            
  const subjectFilter = $('#subjectFilter').value;
  
  // Obtenir les jours utilisÃ©s et les trier
  const days = Array.from(new Set(schedule.time_slots.map(ts=>ts.day))).sort((a,b)=>a-b);
  const getSlotsByDay = d => schedule.time_slots.filter(ts=>ts.day===d).sort((a,b)=>a.index-b.index);

  // En-tÃªte du tableau
  const tbl = $('#table');
  let html = '<thead><tr><th style="width:100px;">CrÃ©neau</th>';
  for(const d of days){ 
    const dayName = DAYS_FR[d] || `Jour ${d}`;
    html += `<th>${dayName}</th>`; 
  }
  html += '</tr></thead><tbody>';

  // Lignes par index de crÃ©neau
  const maxSlots = Math.max(...days.map(d => getSlotsByDay(d).length));
  for(let idx=0; idx<maxSlots; idx++){
    const slot = getSlotsByDay(days[0])[idx]; // Prendre le slot du premier jour pour l'horaire
    const timeLabel = slot ? `${slot.start}-${slot.end}` : `CrÃ©neau ${idx+1}`;
    
    html += `<tr><th style="background:#f3f4f6; color:#111827; font-size:11px;">${idx+1}<br><small>${timeLabel}</small></th>`;
    
    for(const d of days){
      const filterFn = (e) => (
        e.day===d && 
        e.slot_index===idx &&
        (currentTab==='classes' ? e.class_name===selVal : e.teacher_names.includes(selVal)) &&
        (!subjectFilter || e.subject === subjectFilter)
      );

      let cellContent = '';
      if (currentTab === 'teachers') {
        // Regrouper par matiÃ¨re pour agrÃ©ger les classes sur un mÃªme crÃ©neau
        const grouped = {};
        for (const e of schedule.entries.filter(filterFn)) {
          const key = e.subject || 'â€”';
          if (!grouped[key]) grouped[key] = { subject: e.subject || 'â€”', classes: new Set(), room: e.room || '' };
          if (e.class_name) grouped[key].classes.add(e.class_name);
        }
        cellContent = Object.values(grouped).map(g => {
          const classesStr = Array.from(g.classes).sort().join(', ');
          return `
            <div class="cell-content">
              <div class="badge">${g.subject}</div>
              <div class="teacher-info">${classesStr}</div>
            </div>
          `;
        }).join('');
      } else {
        const entries = schedule.entries.filter(filterFn);
        cellContent = entries.map(e => {
          const subj = e.subject || '';
          const displayInfo = e.teacher_names.join(', ');
          return `
            <div class="cell-content">
              <div class="badge">${subj}</div>
              <div class="teacher-info">${displayInfo}</div>
              ${e.room ? `<div class="teacher-info">${e.room}</div>` : ''}
            </div>
          `;
        }).join('');
      }
      
      html += `<td class="cell">${cellContent}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody>';
  tbl.innerHTML = html;
}

function showMeta() {
  if (!schedule || !schedule.meta) return;
  
  const meta = schedule.meta;
  const metaDiv = $('#meta');
  const content = $('#metaContent');
  
  content.innerHTML = `
    <div><strong>Statut:</strong> ${meta.solve_status || 'N/A'}</div>
    <div><strong>Temps de calcul:</strong> ${meta.walltime_sec || 0}s</div>
    <div><strong>Mode avancÃ©:</strong> ${meta.advanced ? 'Oui' : 'Non'}</div>
    <div><strong>EntrÃ©es gÃ©nÃ©rÃ©es:</strong> ${schedule.entries.length}</div>
    ${meta.notes && meta.notes.length > 0 ? `<div><strong>Notes:</strong> ${meta.notes.join(', ')}</div>` : ''}
  `;
  
  metaDiv.style.display = 'block';
}

function exportCSV(){
  if(!schedule || schedule.entries.length === 0) {
    toast('Aucun planning Ã  exporter', 'error');
        return;
    }
    
  const name = $('#selector').value;
  if (!name) {
    toast('SÃ©lectionnez une classe ou un professeur', 'error');
        return;
    }
    
  const subjectFilter = $('#subjectFilter').value;
  const rows = [['Vue','Nom','Jour','CrÃ©neau','Heure','Classe','MatiÃ¨re','Professeurs','Salle']];
  
  for(const e of schedule.entries){
    const match = currentTab==='classes' ? (e.class_name===name) : (e.teacher_names||[]).includes(name);
    if(!match) continue;
    if(subjectFilter && e.subject !== subjectFilter) continue;
    
    const slot = schedule.time_slots.find(ts => ts.day === e.day && ts.index === e.slot_index);
    const timeStr = slot ? `${slot.start}-${slot.end}` : '';
    const dayName = DAYS_FR[e.day] || `Jour ${e.day}`;
    
    rows.push([
      currentTab, 
      name, 
      dayName,
      e.slot_index + 1, 
      timeStr,
      e.class_name, 
      e.subject, 
      (e.teacher_names||[]).join('; '), 
      e.room||''
    ]);
  }
  
  const csv = rows.map(r => r.map(x => `"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'}); // BOM pour Excel
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob); 
  a.download = `emploi_temps_${currentTab}_${name.replace(/[^a-zA-Z0-9]/g, '_')}.csv`; 
  a.click();
  
  toast('Export CSV tÃ©lÃ©chargÃ©', 'success');
}

function resetFilters() {
  $('#subjectFilter').value = '';
  renderAll();
  toast('Filtres rÃ©initialisÃ©s', 'success');
}

// Event listeners
$('#btnRun').addEventListener('click', runAdvanced);
$('#btnExport').addEventListener('click', exportCSV);
$('#btnPrint').addEventListener('click', () => window.print());
$('#btnReset').addEventListener('click', resetFilters);

$$('.tab').forEach(t => t.addEventListener('click', (ev)=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  ev.currentTarget.classList.add('active');
  currentTab = ev.currentTarget.dataset.tab;
  buildSelectors(); 
  renderAll();
}));

$('#selector').addEventListener('change', renderAll);
$('#subjectFilter').addEventListener('change', renderAll);

// DÃ©tection locale RTL (hÃ©breu)
function checkLocale() {
  const locale = document.documentElement.getAttribute('data-locale');
  if (locale === 'he') {
    document.documentElement.setAttribute('dir', 'rtl');
    document.title = '× ×™×”×•×œ ××™×œ×•×¦×™× ×•×™×¦×™×¨×”';
  }
}

// Chargement initial
async function init() {
  checkLocale();
  
  // Essayer de charger un planning existant
  const loaded = await loadSchedule();
  if(loaded && schedule.entries.length > 0) { 
    $('#status').textContent = schedule.meta?.solve_status || 'ChargÃ©';
    showMeta();
    renderAll(); 
        } else {
    $('#status').textContent = 'PrÃªt';
  }
}

// Auto-sauvegarde des prÃ©fÃ©rences dans localStorage
function savePreferences() {
  const prefs = {
    limit_consecutive: $('#limit_consecutive').checked,
    avoid_late_hard: $('#avoid_late_hard').checked,
    minimize_gaps: $('#minimize_gaps').checked,
    friday_short: $('#friday_short').checked,
    morning_priority: $('#morning_priority').checked,
    balanced_days: $('#balanced_days').checked,
    currentTab: currentTab
  };
  localStorage.setItem('constraints_prefs', JSON.stringify(prefs));
}

function loadPreferences() {
  try {
    const prefs = JSON.parse(localStorage.getItem('constraints_prefs') || '{}');
    Object.keys(prefs).forEach(key => {
      const el = $(`#${key}`);
      if (el && typeof prefs[key] === 'boolean') {
        el.checked = prefs[key];
      }
    });
    if (prefs.currentTab) {
      currentTab = prefs.currentTab;
      $(`.tab[data-tab="${currentTab}"]`)?.classList.add('active');
      $(`.tab:not([data-tab="${currentTab}"])`)?.forEach(t => t.classList.remove('active'));
    }
  } catch (e) {
    console.log('Pas de prÃ©fÃ©rences sauvegardÃ©es');
  }
}

// Sauvegarder les prÃ©fÃ©rences quand elles changent
$$('input[type="checkbox"]').forEach(input => {
  input.addEventListener('change', savePreferences);
});

// Initialisation
loadPreferences();
init();
    </script>

    <!-- AGENT CONSEILLER AI -->
    <style>
        /* Agent Conseiller Flottant */
        .advisor-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: transform 0.3s;
            font-size: 28px;
        }
        
        .advisor-toggle:hover {
            transform: scale(1.1);
        }
        
        .advisor-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 999;
        }
        
        .advisor-panel.active {
            display: flex;
        }
        
        .advisor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .advisor-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .advisor-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f7f8fa;
        }
        
        .advisor-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .advisor-message.user {
            flex-direction: row-reverse;
        }
        
        .advisor-message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }
        
        .advisor-message.user .advisor-message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 4px 15px;
        }
        
        .advisor-message.assistant .advisor-message-bubble {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 15px 15px 15px 4px;
        }
        
        .advisor-input-area {
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            background: white;
            border-radius: 0 0 15px 15px;
        }
        
        .advisor-input-wrapper {
            display: flex;
            gap: 10px;
        }
        
        .advisor-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }
        
        .advisor-input:focus {
            border-color: #667eea;
        }
        
        .advisor-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .advisor-typing {
            display: none;
            padding: 10px;
            font-style: italic;
            color: #666;
        }
        
        .advisor-typing.active {
            display: block;
        }
        
        .advisor-suggestions {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .advisor-suggestion {
            background: #f0f4f8;
            border: 1px solid #cbd5e0;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .advisor-suggestion:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Animations pour les notifications de rÃ©gÃ©nÃ©ration */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>

    <!-- Bouton flottant de l'agent -->
    <div class="advisor-toggle" id="advisorToggle" title="Agent Conseiller AI">
        ğŸ¤–
    </div>

    <!-- Panel de l'agent conseiller -->
    <div class="advisor-panel" id="advisorPanel">
        <div class="advisor-header">
            <h3 style="margin:0;">Agent Conseiller AI</h3>
            <button class="advisor-close" id="advisorClose">Ã—</button>
        </div>
        
        <div class="advisor-messages" id="advisorMessages">
            <div class="advisor-message assistant">
                <div class="advisor-message-bubble">
                    Bonjour ! Je suis votre agent conseiller.<br>
                    ×©×œ×•×! ×× ×™ ×”×¡×•×›×Ÿ ×”×™×•×¢×¥ ×©×œ×š.<br><br>
                    Comment puis-je vous aider avec l'emploi du temps ?<br>
                    ××™×š ×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×¢× ××¢×¨×›×ª ×”×©×¢×•×ª?
                </div>
            </div>
        </div>
        
        <div class="advisor-typing" id="advisorTyping">L'agent rÃ©flÃ©chit...</div>
        
        <div class="advisor-input-area">
            <div class="advisor-suggestions">
                <div class="advisor-suggestion" onclick="testAdvisorConnection()" style="background:#e3f2fd;">
                    ğŸ”§ Test
                </div>
                <div class="advisor-suggestion" onclick="sendAdvisorMessage('×ª×•×›×œ ×œ××œ× ××ª ×”×—×•×¨×™× ×‘××¢×¨×›×ª ×”×©×¢×•×ª ×©×œ ×–-1?')">
                    ××œ× ×—×•×¨×™×
                </div>
                <div class="advisor-suggestion" onclick="sendAdvisorMessage('Ã‰quilibrer la charge des classes')">
                    Ã‰quilibrer
                </div>
                <div class="advisor-suggestion" onclick="sendAdvisorMessage('×—×©×•×‘ ×œ×™ ×©×”××ª××˜×™×§×” ×ª×”×™×” ×‘×‘×•×§×¨')">
                    ×”×¢×“×¤×•×ª
                </div>
            </div>
            
            <div class="advisor-input-wrapper">
                <input 
                    type="text" 
                    class="advisor-input" 
                    id="advisorInput" 
                    placeholder="Tapez en franÃ§ais ou ×‘×¢×‘×¨×™×ª..."
                    onkeypress="if(event.key === 'Enter') sendAdvisorMessage()"
                />
                <button class="advisor-send" onclick="sendAdvisorMessage()">
                    Envoyer
                </button>
            </div>
        </div>
    </div>

    <script>
        // Agent Conseiller - Fonctions
        const ADVISOR_API_URL = 'http://localhost:5002/api/advisor';
        let advisorConversation = [];
        
        // Debug function - test de connexion
        async function testAdvisorConnection() {
            try {
                console.log('ğŸ” Test de connexion Ã  l\'agent...');
                const response = await fetch(`${ADVISOR_API_URL}/status`);
                const data = await response.json();
                console.log('âœ… Agent accessible:', data);
                return true;
            } catch (error) {
                console.error('âŒ Agent non accessible:', error);
                return false;
            }
        }
        
        // Toggle panel
        document.getElementById('advisorToggle').addEventListener('click', () => {
            const panel = document.getElementById('advisorPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                document.getElementById('advisorInput').focus();
                // Charger les exemples si premiÃ¨re ouverture
                if (advisorConversation.length === 1) {
                    loadAdvisorExamples();
                }
            }
        });
        
        // Fermer panel
        document.getElementById('advisorClose').addEventListener('click', () => {
            document.getElementById('advisorPanel').classList.remove('active');
        });
        
        // Envoyer message
        async function sendAdvisorMessage(message) {
            const input = document.getElementById('advisorInput');
            const text = message || input.value.trim();
            
            if (!text) return;
            
            // Ajouter message utilisateur
            addAdvisorMessage(text, 'user');
            
            // Vider l'input
            if (!message) input.value = '';
            
            // Montrer indicateur de frappe
            document.getElementById('advisorTyping').classList.add('active');
            
            try {
                // Envoyer Ã  l'API
                const response = await fetch(`${ADVISOR_API_URL}/chat`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        message: text,
                        context: {
                            page: 'constraints_manager',
                            schedule_loaded: schedule && schedule.entries && schedule.entries.length > 0,
                            current_view: currentTab,
                            session_id: 'constraints_manager_' + Date.now()
                        }
                    })
                });
                
                const data = await response.json();
                
                // Ajouter rÃ©ponse
                addAdvisorMessage(data.message, 'assistant');
                
                // Si propositions, afficher boutons
                if (data.proposals && data.proposals.length > 0) {
                    showProposalButtons(data.proposals);
                }
                
                // VÃ©rifier si une rÃ©gÃ©nÃ©ration automatique a eu lieu
                if (data.auto_regenerated === true) {
                    showRegenerationNotification('success', 'Emploi du temps mis Ã  jour automatiquement!', 
                        data.quality_score ? `Score de qualitÃ©: ${data.quality_score}/100` : '');
                } else if (data.auto_regenerated === false && data.suggest_regeneration) {
                    showRegenerationNotification('suggestion', 'Cette contrainte pourrait nÃ©cessiter une rÃ©gÃ©nÃ©ration', 
                        'Cliquez sur "GÃ©nÃ©rer" pour mettre Ã  jour l\'emploi du temps');
                }
                
            } catch (error) {
                console.error('Erreur agent conseiller:', error);
                addAdvisorMessage(
                    "DÃ©solÃ©, je ne peux pas rÃ©pondre pour le moment. VÃ©rifiez que le service est actif sur le port 5002.",
                    'assistant'
                );
            } finally {
                document.getElementById('advisorTyping').classList.remove('active');
            }
        }
        
        // Ajouter message dans la conversation
        function addAdvisorMessage(text, role) {
            const messagesDiv = document.getElementById('advisorMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `advisor-message ${role}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'advisor-message-bubble';
            
            // Convertir markdown basique
            const formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            
            bubbleDiv.innerHTML = formattedText;
            messageDiv.appendChild(bubbleDiv);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Sauvegarder dans l'historique
            advisorConversation.push({ role, text, timestamp: new Date() });
        }
        
        // Afficher boutons de proposition
        function showProposalButtons(proposals) {
            const messagesDiv = document.getElementById('advisorMessages');
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.cssText = 'display:flex; gap:10px; margin:10px; flex-wrap:wrap;';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'âœ… Confirmer';
            confirmBtn.style.cssText = 'padding:8px 15px; background:#22c55e; color:white; border:none; border-radius:20px; cursor:pointer;';
            confirmBtn.onclick = () => confirmProposals(proposals.map(p => p.change_id));
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'âŒ Annuler';
            cancelBtn.style.cssText = 'padding:8px 15px; background:#ef4444; color:white; border:none; border-radius:20px; cursor:pointer;';
            cancelBtn.onclick = () => confirmProposals(proposals.map(p => p.change_id), 'no');
            
            buttonsDiv.appendChild(confirmBtn);
            buttonsDiv.appendChild(cancelBtn);
            messagesDiv.appendChild(buttonsDiv);
        }
        
        // Confirmer propositions
        async function confirmProposals(changeIds, confirmation = 'yes') {
            try {
                const response = await fetch(`${ADVISOR_API_URL}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        change_ids: changeIds,
                        confirmation: confirmation
                    })
                });
                
                const data = await response.json();
                addAdvisorMessage(data.message, 'assistant');
                
                // Si changements appliquÃ©s, recharger l'emploi du temps
                if (data.success && confirmation === 'yes') {
                    setTimeout(() => {
                        loadSchedule();
                        renderAll();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Erreur confirmation:', error);
            }
        }
        
        // Charger exemples
        async function loadAdvisorExamples() {
            try {
                const response = await fetch(`${ADVISOR_API_URL}/examples`);
                const data = await response.json();
                
                if (data.success) {
                    console.log('Exemples chargÃ©s:', data.examples);
                }
            } catch (error) {
                console.log('Pas d\'exemples disponibles');
            }
        }
        
        // DÃ©tection de la langue pour l'interface
        function detectHebrewText(text) {
            const hebrewChars = (text.match(/[\u0590-\u05FF]/g) || []).length;
            const totalChars = text.replace(/[^a-zA-Z\u0590-\u05FF]/g, '').length;
            return totalChars > 0 && (hebrewChars / totalChars) > 0.3;
        }
        
        // Afficher notification de rÃ©gÃ©nÃ©ration
        function showRegenerationNotification(type, title, message) {
            // CrÃ©er la notification
            const notification = document.createElement('div');
            notification.className = 'regeneration-notification ' + type;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : '#fff3cd'};
                color: ${type === 'success' ? '#155724' : '#856404'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : '#ffeaa7'};
                border-radius: 8px;
                padding: 15px 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                z-index: 10000;
                max-width: 350px;
                animation: slideInRight 0.3s ease;
            `;
            
            const icon = type === 'success' ? 'âœ…' : 'ğŸ’¡';
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <span style="font-size: 20px;">${icon}</span>
                    <strong>${title}</strong>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="margin-left: auto; background: none; border: none; font-size: 18px; cursor: pointer;">Ã—</button>
                </div>
                ${message ? `<div style="margin-left: 30px; font-size: 14px;">${message}</div>` : ''}
                ${type === 'success' ? '<div style="margin-left: 30px; margin-top: 8px;"><button onclick="window.location.reload()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ğŸ”„ Actualiser la page</button></div>' : ''}
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove aprÃ¨s 15 secondes pour success, 10 pour suggestion
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, type === 'success' ? 15000 : 10000);
        }
        
        // Message de bienvenue selon la langue
        setTimeout(() => {
            const locale = document.documentElement.getAttribute('data-locale');
            if (locale === 'he') {
                addAdvisorMessage(
                    "×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×¢×:\nâ€¢ ××™×œ×•×™ ×—×•×¨×™× ×‘××¢×¨×›×ª\nâ€¢ ××™×–×•×Ÿ ×¢×•××¡×™×\nâ€¢ ×”×’×“×¨×ª ×”×¢×“×¤×•×ª\nâ€¢ ××•×¤×˜×™××™×–×¦×™×” ×©×œ ×”××¢×¨×›×ª",
                    'assistant'
                );
            }
        }, 2000);
    </script>
</body>
</html>
</html>
