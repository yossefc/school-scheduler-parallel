<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de contraintes - Emploi du temps scolaire</title>
    
    <!-- Socket.IO pour la connexion WebSocket avec l'IA -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --border: #bdc3c7;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f6fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-indicator.connected {
            background: var(--success);
        }

        .status-indicator.error {
            background: var(--danger);
        }

        .ai-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
        }

        .ai-status.connected {
            background: #7b1fa2;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .card-header h2 {
            color: var(--primary);
            font-size: 20px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success {
            background: var(--success);
            color: white;
        }

        .badge.warning {
            background: var(--warning);
            color: white;
        }

        .badge.danger {
            background: var(--danger);
            color: white;
        }

        .badge.info {
            background: var(--secondary);
            color: white;
        }

        .badge.secondary {
            background: var(--light);
            color: var(--dark);
        }

        .constraint-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }

        .constraint-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .constraint-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid var(--secondary);
            transition: all 0.2s;
        }

        .constraint-item:hover {
            background: #e9ecef;
        }

        .constraint-item.inactive {
            opacity: 0.6;
            border-left-color: var(--border);
        }

        .constraint-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .constraint-title {
            font-weight: 600;
            color: var(--dark);
        }

        .constraint-details {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .constraint-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .info-panel {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-panel.ai-analysis {
            background: #f3e5f5;
            border-color: #ce93d8;
        }

        .info-panel.ai-analysis h3 {
            color: #7b1fa2;
        }

        .info-list {
            list-style: none;
            padding-left: 0;
        }

        .info-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--secondary);
            gap: 15px;
        }

        .spinner-border {
            width: 30px;
            height: 30px;
            border: 3px solid var(--light);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab:hover {
            color: var(--secondary);
        }

        .tab.active {
            color: var(--secondary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
        }

        .ai-analysis-result {
            padding: 15px;
        }

        .analysis-details {
            margin: 15px 0;
        }

        .analysis-details p {
            margin-bottom: 10px;
        }

        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            transition: width 0.3s ease;
        }

        .clarification-panel {
            padding: 15px;
        }

        .questions-list {
            margin: 15px 0;
        }

        .clarification-answer {
            width: 100%;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }

        .schedule-preview {
            margin-top: 20px;
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center;
        }

        .schedule-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .schedule-table td {
            background: white;
        }

        .schedule-table td.has-course {
            background: #e8f5e9;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üìÖ Gestionnaire de contraintes
                <span class="status-indicator connected" id="status">
                    <span class="icon">‚óè</span> Backend
                </span>
                <span class="ai-status" id="ai-status">
                    <span class="icon">ü§ñ</span> IA
                </span>
            </h1>
            <p>Syst√®me de planification d'emploi du temps scolaire isra√©lien avec assistant IA</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-constraints">0</div>
                <div class="stat-label">Contraintes actives</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-teachers">0</div>
                <div class="stat-label">Professeurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-classes">0</div>
                <div class="stat-label">Classes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-success">0%</div>
                <div class="stat-label">Taux de r√©ussite</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('constraints')">Contraintes</button>
            <button class="tab" onclick="switchTab('schedule')">Emploi du temps</button>
            <button class="tab" onclick="switchTab('analysis')">Analyse</button>
        </div>

        <div id="tab-constraints" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h2>Nouvelle contrainte</h2>
                        <span class="badge warning">IA Assistant</span>
                    </div>
                    
                    <form class="constraint-form" id="constraintForm">
                        <div class="form-group">
                            <label for="constraintText">D√©crivez votre contrainte en langage naturel (fran√ßais ou h√©breu) :</label>
                            <textarea class="form-control" id="constraintText" 
                                placeholder="Exemples :&#10;- Le professeur Cohen n'est pas disponible le vendredi apr√®s-midi&#10;- ◊õ◊ú ◊©◊¢◊î ◊™◊§◊ô◊ú◊î ◊¶◊®◊ô◊õ◊ô◊ù ◊ú◊î◊ô◊ï◊™ ◊ë◊©◊¢◊î ◊®◊ê◊©◊ï◊†◊î&#10;- Les classes de math√©matiques ne doivent pas √™tre apr√®s 15h"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="priority">Priorit√© par d√©faut :</label>
                            <select id="priority" class="form-control">
                                <option value="0">üî¥ HARD - Incontournable</option>
                                <option value="1">üü† Tr√®s forte</option>
                                <option value="2" selected>üü° Moyenne</option>
                                <option value="3">üîµ Normale</option>
                                <option value="4">üü¢ Faible</option>
                            </select>
                        </div>
                        
                        <div class="info-panel ai-analysis" id="aiAnalysis" style="display: none;">
                            <h3>ü§ñ Analyse IA</h3>
                            <div id="aiContent"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <span class="icon">ü§ñ</span> Analyser avec l'IA
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Contraintes actives</h2>
                        <span class="badge success" id="constraintCount">0</span>
                    </div>
                    
                    <div class="constraint-list" id="constraintList">
                        <div class="loading">
                            <div class="spinner-border"></div>
                            <p>Chargement des contraintes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-schedule" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Aper√ßu de l'emploi du temps</h2>
                    <button class="btn btn-success" onclick="generateSchedule()">
                        <span class="icon">üîÑ</span> G√©n√©rer
                    </button>
                </div>
                
                <div id="schedulePreview">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Cliquez sur "G√©n√©rer" pour cr√©er un nouvel emploi du temps avec les contraintes actuelles
                    </p>
                </div>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Analyse des contraintes</h2>
                </div>
                
                <div id="analysisContent">
                    <div class="info-panel">
                        <h3>üìä Informations collect√©es</h3>
                        <ul class="info-list" id="collectedInfo">
                            <li><span class="icon">‚úì</span> Aucune contrainte ajout√©e</li>
                        </ul>
                    </div>
                    
                    <div class="info-panel" style="background: #ffebee; border-color: #ffcdd2;">
                        <h3>‚ùó Informations manquantes</h3>
                        <ul class="info-list" id="missingInfo">
                            <li><span class="icon">‚ö†</span> Chargez les donn√©es de base</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION ET VARIABLES GLOBALES
        // ============================================
        
        const API_BASE = 'http://localhost:8000';  // Backend principal
        const AI_API = 'http://localhost:5001';    // API IA avec WebSocket
        
        let currentConstraints = [];
        let scheduleData = null;
        let socket = null;  // WebSocket connection
        let aiSessionId = null;
        let pendingConstraint = null;  // Contrainte en attente de confirmation

        // ============================================
        // MAPPING DES TYPES POUR LE BACKEND
        // ============================================
        
        const TYPE_MAPPING = {
            'custom': 'time_preference',
            'teacher_availability': 'teacher_availability',
            'time_preference': 'time_preference',
            'class_preference': 'time_preference',
            'room_availability': 'room_availability',
            'morning_prayer': 'morning_prayer',
            'lunch_break': 'lunch_break',
            'friday_early_end': 'friday_early_end',
            'consecutive_hours_limit': 'consecutive_hours_limit',
            'parallel_teaching': 'parallel_teaching',
            'school_hours': 'school_hours'
        };

        // ============================================
        // CONNEXION WEBSOCKET AVEC L'IA
        // ============================================
        
        function initializeAIConnection() {
            socket = io(AI_API, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', () => {
                console.log('‚úÖ Connect√© √† l\'agent IA');
                const aiStatus = document.getElementById('ai-status');
                aiStatus.className = 'ai-status connected';
                aiStatus.innerHTML = '<span class="icon">ü§ñ</span> IA Connect√©e';
                showAlert('Agent IA connect√©', 'success');
            });
            
            socket.on('connected', (data) => {
                aiSessionId = data.session_id;
                console.log('Session IA:', aiSessionId);
            });
            
            socket.on('ai_response', (response) => {
                console.log('üì® R√©ponse IA:', response);
                handleAIResponse(response);
            });
            
            socket.on('disconnect', () => {
                console.log('‚ùå D√©connect√© de l\'agent IA');
                const aiStatus = document.getElementById('ai-status');
                aiStatus.className = 'ai-status error';
                aiStatus.innerHTML = '<span class="icon">ü§ñ</span> IA D√©connect√©e';
                showAlert('Agent IA d√©connect√©', 'warning');
            });
            
            socket.on('error', (error) => {
                console.error('Erreur WebSocket:', error);
            });
        }

        // ============================================
        // GESTION DES R√âPONSES DE L'IA
        // ============================================
        
        function handleAIResponse(response) {
            const aiContent = document.getElementById('aiContent');
            
            if (response.status === 'error') {
                aiContent.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Erreur:</strong> ${response.message}
                    </div>
                `;
                return;
            }
            
            // Si l'IA demande des clarifications
            if (response.clarification_questions && response.clarification_questions.length > 0) {
                displayClarificationQuestions(response.clarification_questions);
                return;
            }
            
            // Si l'IA a analys√© la contrainte
            if (response.constraint) {
                const constraint = response.constraint;
                
                aiContent.innerHTML = `
                    <div class="ai-analysis-result">
                        <h5>‚úÖ Analyse termin√©e</h5>
                        <div class="analysis-details">
                            <p><strong>Type d√©tect√©:</strong> 
                                <span class="badge badge-info">${constraint.type}</span>
                            </p>
                            <p><strong>Entit√©:</strong> 
                                <span class="badge badge-secondary">${constraint.entity || 'Global'}</span>
                            </p>
                            <p><strong>Confiance:</strong></p>
                            <div class="progress">
                                <div class="progress-bar" 
                                     style="width: ${(constraint.confidence || 0.8) * 100}%">
                                    ${Math.round((constraint.confidence || 0.8) * 100)}%
                                </div>
                            </div>
                            <p><strong>Donn√©es extraites:</strong></p>
                            <pre>${JSON.stringify(constraint.data, null, 2)}</pre>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="confirmConstraint()">
                                ‚úÖ Confirmer et ajouter
                            </button>
                            <button class="btn btn-warning" onclick="modifyConstraint()">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button class="btn btn-danger" onclick="cancelConstraint()">
                                ‚ùå Annuler
                            </button>
                        </div>
                    </div>
                `;
                
                // Sauvegarder temporairement la contrainte analys√©e
                pendingConstraint = constraint;
            }
        }

        // ============================================
        // GESTION DES CLARIFICATIONS
        // ============================================
        
        function displayClarificationQuestions(questions) {
            const aiContent = document.getElementById('aiContent');
            
            let html = `
                <div class="clarification-panel">
                    <h5>ü§î L'agent IA a besoin de pr√©cisions :</h5>
                    <div class="questions-list">
            `;
            
            questions.forEach((q, index) => {
                html += `
                    <div class="form-group">
                        <label class="font-weight-bold">${q}</label>
                        <input type="text" 
                               class="form-control clarification-answer" 
                               data-index="${index}"
                               placeholder="Votre r√©ponse...">
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <button class="btn btn-primary" onclick="submitClarifications()">
                        üì§ Envoyer les r√©ponses
                    </button>
                </div>
            `;
            
            aiContent.innerHTML = html;
        }

        function submitClarifications() {
            const answers = [];
            document.querySelectorAll('.clarification-answer').forEach(input => {
                answers.push(input.value);
            });
            
            const originalText = document.getElementById('constraintText').value;
            const clarifiedText = originalText + '\n' + answers.join('\n');
            
            // Renvoyer avec les clarifications
            socket.emit('message', {
                text: clarifiedText,
                clarification_answers: answers,
                original_text: originalText
            });
        }

        // ============================================
        // FORMATAGE DES DONN√âES POUR LE BACKEND
        // ============================================
        
        function formatDataForBackend(type, data, entity, originalText) {
            const backendType = TYPE_MAPPING[type] || 'time_preference';
            let formattedData = {};
            
            switch(backendType) {
                case 'teacher_availability':
                    formattedData = {
                        unavailable_days: data.unavailable_days || [],
                        unavailable_periods: data.unavailable_periods || [],
                        reason: originalText || "Non sp√©cifi√©"
                    };
                    break;
                    
                case 'morning_prayer':
                    formattedData = {
                        time_slot: data.time_slot || "08:00-08:30",
                        mandatory_for: ["all"]
                    };
                    break;
                    
                case 'time_preference':
                    formattedData = {
                        preferred_time: "morning",
                        preferred_periods: data.preferred_periods || [],
                        avoid_periods: data.avoid_periods || [],
                        description: originalText
                    };
                    break;
                    
                case 'lunch_break':
                    formattedData = {
                        time_slot: data.time_slot || "12:15-12:45",
                        mandatory_for: ["all"]
                    };
                    break;
                    
                case 'friday_early_end':
                    formattedData = {
                        end_time: data.end_time || "13:00",
                        applies_to: ["all"]
                    };
                    break;
                    
                default:
                    formattedData = {
                        description: originalText,
                        parameters: data
                    };
            }
            
            return {
                type: backendType,
                data: formattedData
            };
        }

        // ============================================
        // SOUMISSION DU FORMULAIRE
        // ============================================
        
        document.getElementById('constraintForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const text = document.getElementById('constraintText').value;
            if (!text.trim()) {
                showAlert('Veuillez entrer une contrainte', 'warning');
                return;
            }
            
            // Afficher le panneau d'analyse
            const aiPanel = document.getElementById('aiAnalysis');
            const aiContent = document.getElementById('aiContent');
            
            aiPanel.style.display = 'block';
            aiContent.innerHTML = `
                <div class="loading">
                    <div class="spinner-border"></div>
                    <p>ü§ñ Analyse de votre contrainte par l'agent IA...</p>
                </div>
            `;
            
            // Envoyer au serveur IA via WebSocket
            if (socket && socket.connected) {
                socket.emit('message', {
                    text: text,
                    context: {
                        current_constraints: currentConstraints,
                        priority: document.getElementById('priority')?.value || 2
                    }
                });
            } else {
                // Fallback : Appel HTTP si WebSocket non disponible
                await analyzeConstraintViaHTTP(text);
            }
        });

        // ============================================
        // FALLBACK HTTP
        // ============================================
        
        async function analyzeConstraintViaHTTP(text) {
            try {
                const response = await fetch(`${AI_API}/api/ai/apply_constraint`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        constraint_text: text,
                        context: {
                            current_constraints: currentConstraints,
                            priority: document.getElementById('priority')?.value || 2
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    handleAIResponse(data);
                } else {
                    throw new Error('Erreur serveur IA');
                }
            } catch (error) {
                console.error('Erreur HTTP:', error);
                // Fallback vers analyse locale simple
                const analysis = analyzeConstraintLocally(text);
                handleAIResponse({
                    status: 'success',
                    constraint: analysis
                });
            }
        }

        // ============================================
        // ANALYSE LOCALE DE SECOURS
        // ============================================
        
        function analyzeConstraintLocally(text) {
            const lowerText = text.toLowerCase();
            
            // D√©tection de mots-cl√©s en h√©breu
            const hebrewKeywords = {
                prayer: ['◊™◊§◊ô◊ú◊î', '◊™◊§◊ô◊ú◊™', '◊©◊ó◊®◊ô◊™', '◊û◊†◊ó◊î', '◊¢◊®◊ë◊ô◊™'],
                teacher: ['◊û◊ï◊®◊î', '◊û◊ï◊®◊ô◊ù', '◊û◊ú◊û◊ì', '◊û◊ú◊û◊ì◊™'],
                class: ['◊õ◊ô◊™◊î', '◊õ◊ô◊™◊ï◊™', '◊™◊ú◊û◊ô◊ì◊ô◊ù'],
                hour: ['◊©◊¢◊î', '◊©◊¢◊ï◊™'],
                first: ['◊®◊ê◊©◊ï◊†◊î', '◊®◊ê◊©◊ï◊ü', '◊ë◊ï◊ß◊®'],
                day: ['◊®◊ê◊©◊ï◊ü', '◊©◊†◊ô', '◊©◊ú◊ô◊©◊ô', '◊®◊ë◊ô◊¢◊ô', '◊ó◊û◊ô◊©◊ô', '◊©◊ô◊©◊ô'],
                friday: ['◊©◊ô◊©◊ô', '◊ô◊ï◊ù ◊©◊ô◊©◊ô']
            };
            
            let type = 'time_preference';
            let entity = 'Global';
            let data = {
                original_text: text,
                timestamp: new Date().toISOString()
            };
            
            // D√©tection de pri√®re
            if (hebrewKeywords.prayer.some(word => text.includes(word)) || 
                lowerText.includes('pri√®re') || lowerText.includes('tefila')) {
                type = 'morning_prayer';
                data.time_slot = '08:00-08:30';
                data.mandatory_for = ['all'];
            }
            
            // D√©tection de professeur
            const profRegexFr = /(?:professeur|prof\.?|enseignant)\s+([A-Z][a-z√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√ß≈ì√¶]+)/i;
            const profMatch = text.match(profRegexFr);
            
            if (profMatch) {
                entity = profMatch[1];
                type = 'teacher_availability';
                
                // Extraction des jours
                const jourRegex = /(lundi|mardi|mercredi|jeudi|vendredi|dimanche)/gi;
                const jours = text.match(jourRegex);
                if (jours) {
                    data.unavailable_days = jours.map(j => j.toLowerCase());
                }
            }
            
            // D√©tection vendredi court
            if (hebrewKeywords.friday.some(word => text.includes(word)) || 
                lowerText.includes('vendredi')) {
                if (lowerText.includes('court') || lowerText.includes('t√¥t')) {
                    type = 'friday_early_end';
                    data.end_time = '13:00';
                }
            }
            
            return {
                type: type,
                entity: entity,
                data: data,
                confidence: 0.6  // Confiance plus faible pour l'analyse locale
            };
        }

        // ============================================
        // CONFIRMATION ET ENVOI DE LA CONTRAINTE
        // ============================================
        
        async function confirmConstraint() {
            if (!pendingConstraint) {
                showAlert('Aucune contrainte √† confirmer', 'warning');
                return;
            }
            
            const originalText = document.getElementById('constraintText').value;
            const { type: backendType, data: formattedData } = formatDataForBackend(
                pendingConstraint.type,
                pendingConstraint.data,
                pendingConstraint.entity,
                originalText
            );
            
            const constraint = {
                type: backendType,
                entity: pendingConstraint.entity || 'Global',
                priority: parseInt(document.getElementById('priority')?.value || '2'),
                data: formattedData,
                is_active: true,
                ai_confidence: pendingConstraint.confidence,
                original_text: originalText
            };
            
            console.log('Envoi de la contrainte:', constraint);
            
            try {
                const response = await fetch(`${API_BASE}/constraints/`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(constraint)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erreur du serveur:', errorData);
                    
                    if (errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            const errors = errorData.detail.map(e => 
                                `${e.loc ? e.loc.join('.') : 'Champ'}: ${e.msg}`
                            ).join('<br>');
                            showAlert(`Erreur de validation:<br>${errors}`, 'danger');
                        } else {
                            showAlert(`Erreur: ${errorData.detail}`, 'danger');
                        }
                    } else {
                        showAlert('Erreur lors de l\'ajout de la contrainte', 'danger');
                    }
                    return;
                }
                
                const result = await response.json();
                
                // Ajouter √† la liste locale
                const newConstraint = {
                    ...constraint,
                    constraint_id: result.id || 'constraint_' + Date.now()
                };
                
                currentConstraints.push(newConstraint);
                displayConstraints();
                updateStats();
                
                // R√©initialiser
                document.getElementById('constraintForm').reset();
                document.getElementById('aiAnalysis').style.display = 'none';
                pendingConstraint = null;
                
                showAlert('‚úÖ Contrainte ajout√©e avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur r√©seau:', error);
                showAlert(`Erreur de connexion: ${error.message}`, 'danger');
            }
        }

        function modifyConstraint() {
            // Remplir le textarea avec les donn√©es actuelles
            if (pendingConstraint && pendingConstraint.data.original_text) {
                document.getElementById('constraintText').value = pendingConstraint.data.original_text;
            }
            document.getElementById('aiAnalysis').style.display = 'none';
            pendingConstraint = null;
        }

        function cancelConstraint() {
            document.getElementById('aiAnalysis').style.display = 'none';
            pendingConstraint = null;
        }

        // ============================================
        // GESTION DES ONGLETS
        // ============================================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ============================================
        // CHARGEMENT ET AFFICHAGE DES CONTRAINTES
        // ============================================
        
        async function loadConstraints() {
            try {
                const response = await fetch(`${API_BASE}/constraints`);
                if (response.ok) {
                    currentConstraints = await response.json();
                    displayConstraints();
                    updateStats();
                    updateAnalysis();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des contraintes:', error);
                showAlert('Erreur de connexion au serveur', 'danger');
            }
        }

        function displayConstraints() {
            const container = document.getElementById('constraintList');
            
            if (currentConstraints.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Aucune contrainte d√©finie</p>';
                return;
            }
            
            container.innerHTML = currentConstraints.map(constraint => `
                <div class="constraint-item ${constraint.is_active ? '' : 'inactive'}">
                    <div class="constraint-header">
                        <div>
                            <div class="constraint-title">${constraint.entity || 'Global'}</div>
                            <div class="constraint-details">
                                Type: ${constraint.type || constraint.constraint_type} | 
                                Priorit√©: ${getPriorityLabel(constraint.priority)}
                            </div>
                            <div class="constraint-details">
                                ${formatConstraintData(constraint.type || constraint.constraint_type, constraint.data || constraint.constraint_data)}
                            </div>
                        </div>
                        <span class="badge ${constraint.is_active ? 'success' : 'secondary'}">
                            ${constraint.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="constraint-actions">
                        <button class="btn btn-sm btn-secondary" onclick="toggleConstraint('${constraint.constraint_id}')">
                            ${constraint.is_active ? '‚ùå D√©sactiver' : '‚úì Activer'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteConstraint('${constraint.constraint_id}')">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('constraintCount').textContent = 
                currentConstraints.filter(c => c.is_active).length;
        }

        function formatConstraintData(type, data) {
            if (!data || Object.keys(data).length === 0) {
                return '<em>Aucune donn√©e sp√©cifique</em>';
            }
            
            const parts = [];
            
            switch(type) {
                case 'teacher_availability':
                    if (data.unavailable_days && data.unavailable_days.length > 0) {
                        parts.push(`Jours: ${data.unavailable_days.join(', ')}`);
                    }
                    if (data.unavailable_periods && data.unavailable_periods.length > 0) {
                        parts.push(`P√©riodes: ${data.unavailable_periods.join(', ')}`);
                    }
                    if (data.reason) {
                        parts.push(`Raison: ${data.reason}`);
                    }
                    break;
                    
                case 'morning_prayer':
                    if (data.time_slot) {
                        parts.push(`Horaire: ${data.time_slot}`);
                    }
                    break;
                    
                case 'friday_early_end':
                    if (data.end_time) {
                        parts.push(`Fin des cours: ${data.end_time}`);
                    }
                    break;
                    
                case 'time_preference':
                    if (data.description) {
                        parts.push(data.description);
                    }
                    break;
                    
                default:
                    // Affichage g√©n√©rique
                    Object.entries(data).forEach(([key, value]) => {
                        if (key !== 'timestamp' && key !== 'created_at' && key !== 'original_text') {
                            if (Array.isArray(value)) {
                                parts.push(`${key}: ${value.join(', ')}`);
                            } else {
                                parts.push(`${key}: ${value}`);
                            }
                        }
                    });
            }
            
            return parts.length > 0 ? parts.join(' | ') : '<em>Configuration d√©finie</em>';
        }

        function getPriorityLabel(priority) {
            const labels = {
                0: 'Incontournable',
                1: 'Tr√®s forte',
                2: 'Moyenne',
                3: 'Normale',
                4: 'Faible'
            };
            return labels[priority] || 'Inconnue';
        }

        // ============================================
        // ACTIONS SUR LES CONTRAINTES
        // ============================================
        
        async function toggleConstraint(id) {
            const constraint = currentConstraints.find(c => c.constraint_id === id);
            if (!constraint) return;
            
            try {
                const response = await fetch(`${API_BASE}/constraints/${id}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: !constraint.is_active })
                });
                
                if (response.ok) {
                    showAlert('Contrainte mise √† jour', 'success');
                    loadConstraints();
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors de la mise √† jour', 'danger');
            }
        }

        async function deleteConstraint(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette contrainte ?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/constraints/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Contrainte supprim√©e', 'success');
                    loadConstraints();
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur lors de la suppression', 'danger');
            }
        }

        // ============================================
        // G√âN√âRATION D'EMPLOI DU TEMPS
        // ============================================
        
        async function generateSchedule() {
            const preview = document.getElementById('schedulePreview');
            preview.innerHTML = `
                <div class="loading">
                    <div class="spinner-border"></div>
                    <p>G√©n√©ration en cours...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/generate_schedule`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        constraints: currentConstraints.filter(c => c.is_active),
                        time_limit: 60
                    })
                });
                
                if (response.ok) {
                    scheduleData = await response.json();
                    displaySchedule();
                    showAlert('Emploi du temps g√©n√©r√© avec succ√®s', 'success');
                } else {
                    const error = await response.json();
                    preview.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Erreur:</strong> ${error.detail || 'Impossible de g√©n√©rer l\'emploi du temps'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur:', error);
                preview.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Erreur de connexion:</strong> V√©rifiez que le serveur est d√©marr√©
                    </div>
                `;
            }
        }

        function displaySchedule() {
            if (!scheduleData || !scheduleData.schedule) return;
            
            const preview = document.getElementById('schedulePreview');
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven'];
            const periods = 10;
            
            // Grouper par classe
            const byClass = {};
            scheduleData.schedule.forEach(entry => {
                if (!byClass[entry.class_name]) {
                    byClass[entry.class_name] = {};
                }
                const key = `${entry.day}_${entry.period}`;
                byClass[entry.class_name][key] = entry;
            });
            
            // Cr√©er le tableau HTML
            let html = '<div class="schedule-preview">';
            
            Object.entries(byClass).forEach(([className, schedule]) => {
                html += `<h3 style="margin-top: 20px;">Classe: ${className}</h3>`;
                html += '<table class="schedule-table"><thead><tr><th>P√©riode</th>';
                
                days.forEach(day => {
                    html += `<th>${day}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                for (let period = 1; period <= periods; period++) {
                    html += `<tr><td>${period}</td>`;
                    
                    for (let day = 0; day < 6; day++) {
                        const key = `${day}_${period}`;
                        const entry = schedule[key];
                        
                        if (entry) {
                            html += `<td class="has-course">
                                <strong>${entry.subject_name || entry.subject}</strong><br>
                                <small>${entry.teacher_name}</small>
                            </td>`;
                        } else {
                            html += '<td>-</td>';
                        }
                    }
                    html += '</tr>';
                }
                
                html += '</tbody></table>';
            });
            
            html += '</div>';
            
            if (scheduleData.statistics) {
                html += `
                    <div class="info-panel" style="margin-top: 20px;">
                        <h3>üìä Statistiques</h3>
                        <p>Total d'assignations: ${scheduleData.statistics.total_assignments}</p>
                        <p>Professeurs utilis√©s: ${scheduleData.statistics.teachers_used.join(', ')}</p>
                        <p>Classes couvertes: ${scheduleData.statistics.classes_covered.join(', ')}</p>
                    </div>
                `;
            }
            
            preview.innerHTML = html;
        }

        // ============================================
        // MISE √Ä JOUR DES STATISTIQUES ET ANALYSES
        // ============================================
        
        function updateStats() {
            const activeCount = currentConstraints.filter(c => c.is_active).length;
            document.getElementById('stat-constraints').textContent = activeCount;
            
            // Simulation des autres stats
            document.getElementById('stat-teachers').textContent = '12';
            document.getElementById('stat-classes').textContent = '8';
            document.getElementById('stat-success').textContent = activeCount > 5 ? '85%' : '95%';
        }

        function updateAnalysis() {
            const collected = document.getElementById('collectedInfo');
            const missing = document.getElementById('missingInfo');
            
            // Informations collect√©es
            const collectedItems = [];
            const entityTypes = new Set();
            const constraintTypes = new Set();
            
            currentConstraints.forEach(c => {
                if (c.entity) entityTypes.add(c.entity);
                constraintTypes.add(c.type || c.constraint_type);
            });
            
            if (entityTypes.size > 0) {
                collectedItems.push(`${entityTypes.size} entit√©s configur√©es`);
            }
            if (constraintTypes.size > 0) {
                collectedItems.push(`${constraintTypes.size} types de contraintes`);
            }
            
            collected.innerHTML = collectedItems.length > 0 
                ? collectedItems.map(item => `<li><span class="icon">‚úì</span> ${item}</li>`).join('')
                : '<li><span class="icon">‚úì</span> Aucune contrainte ajout√©e</li>';
            
            // Informations manquantes
            const missingItems = [];
            
            if (!currentConstraints.some(c => (c.type || c.constraint_type) === 'friday_early_end')) {
                missingItems.push('Configuration du vendredi court');
            }
            if (!currentConstraints.some(c => (c.type || c.constraint_type) === 'morning_prayer')) {
                missingItems.push('Horaires de pri√®re du matin');
            }
            if (!currentConstraints.some(c => (c.type || c.constraint_type) === 'lunch_break')) {
                missingItems.push('Configuration des pauses d√©jeuner');
            }
            
            missing.innerHTML = missingItems.length > 0
                ? missingItems.map(item => `<li><span class="icon">‚ö†</span> ${item}</li>`).join('')
                : '<li><span class="icon">‚úì</span> Toutes les informations de base sont configur√©es</li>';
        }

        // ============================================
        // UTILITAIRES
        // ============================================
        
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span class="icon">${type === 'success' ? '‚úì' : type === 'danger' ? '‚úó' : '‚ö†'}</span>
                ${message}
            `;
            
            document.querySelector('.container').insertBefore(alert, document.querySelector('.stats-grid'));
            
            setTimeout(() => alert.remove(), 5000);
        }

        // ============================================
        // INITIALISATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialiser la connexion IA
            initializeAIConnection();
            
            // Charger les contraintes
            loadConstraints();
            
            // Rafra√Æchissement automatique des contraintes
            setInterval(loadConstraints, 30000);
            
            // V√©rification de la connexion backend
            setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/constraints`);
                    const status = document.getElementById('status');
                    
                    if (response.ok) {
                        status.className = 'status-indicator connected';
                        status.innerHTML = '<span class="icon">‚óè</span> Backend OK';
                    } else {
                        throw new Error();
                    }
                } catch {
                    const status = document.getElementById('status');
                    status.className = 'status-indicator error';
                    status.innerHTML = '<span class="icon">‚óè</span> Backend KO';
                }
            }, 5000);
        });
    </script>
</body>
</html>